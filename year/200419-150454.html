<!DOCTYPE html><html lang="zh-CN"><head><meta name="generator" content="Hexo 3.8.0"><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"><meta name="description" content="【CS学习笔记】5、如何建立Payload处理器"><meta name="keywords" content="Cobalt Strike,学习笔记,红队"><meta name="author" content="Teams Six,undefined"><meta name="copyright" content="Teams Six"><title>【CS学习笔记】5、如何建立Payload处理器【Teams Six】</title><link rel="stylesheet" href="/css/fan.css"><link rel="stylesheet" href="/css/thirdparty/jquery.mCustomScrollbar.min.css"><link rel="icon" href="/favicon.ico"><!-- script(src="http://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML")--><script src="/js/mathjax/mathjax.js"></script><script type="text/x-mathjax-config">MathJax.Hub.Config({
    tex2jax: {inlineMath: [['$', '$'], ['\\(', '\\)']]}
});
</script><script>var isPassword = '' || false;
if (isPassword) {
    if (prompt('请输入文章密码') !== '') {
        alert('密码错误！');
        history.back();
    }
}</script><script>window.GLOBAL_CONFIG = {
  root: '/',
  algolia: undefined,
  localSearch: {"path":"search.json","languages":{"hits_empty":"local_search.hits_empty"}},
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  }
}</script></head><body><canvas id="universe"></canvas><!--#body--><div id="sidebar"><div class="toggle-sidebar-info button-hover"><span data-toggle="文章目录">站点概览</span></div><div class="sidebar-toc"><div class="sidebar-toc-title">目录</div><div class="sidebar-toc-progress"><span class="progress-notice">您已阅读了</span><span class="progress-num">0</span><span class="progress-percentage">%</span><div class="sidebar-toc-progress-bar"></div></div><div class="sidebar-toc-content" id="sidebar-toc-content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#0x00-监听器管理"><span class="toc-number">1.</span> <span class="toc-text">0x00 监听器管理</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#0x01-什么是传输器"><span class="toc-number">2.</span> <span class="toc-text">0x01 什么是传输器</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#0x02-创建监听器"><span class="toc-number">3.</span> <span class="toc-text">0x02 创建监听器</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#0x03-Beacon是什么"><span class="toc-number">4.</span> <span class="toc-text">0x03 Beacon是什么</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#0x04-Beacon的类型"><span class="toc-number">5.</span> <span class="toc-text">0x04 Beacon的类型</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#0x05-创建一个HTTP-Beacon"><span class="toc-number">6.</span> <span class="toc-text">0x05 创建一个HTTP Beacon</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#0x06-重定向器"><span class="toc-number">7.</span> <span class="toc-text">0x06 重定向器</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#0x07-创建一个重定向器"><span class="toc-number">8.</span> <span class="toc-text">0x07 创建一个重定向器</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#0x08-HTTPS-Beacon"><span class="toc-number">9.</span> <span class="toc-text">0x08 HTTPS Beacon</span></a></li></ol></div></div><div class="author-info hide"><div class="author-info-avatar"><img class="author-info-avatar-img" src="/avatar.png"></div><div class="author-info-name">Teams Six</div><div class="author-info-description"></div><div class="links-buttons"><a class="links-button button-hover" href="https://github.com/teamssix" target="_blank">GitHub<i class="icon-dot bg-color3"></i></a><a class="links-button button-hover" href="https://me.csdn.net/qq_37683287" target="_blank">CSDN<i class="icon-dot bg-color7"></i></a><a class="links-button button-hover" href="https://twitter.com/TeamsSix" target="_blank">Twitter<i class="icon-dot bg-color5"></i></a><a class="links-button button-hover" href="https://instagram.com/TeamsSix" target="_blank">Instagram<i class="icon-dot bg-color8"></i></a><a class="links-button button-hover" href="https://www.youtube.com/channel/UCKeJhJYi_tmXWETzVxKbSvA" target="_blank">YouTube<i class="icon-dot bg-color3"></i></a><a class="links-button button-hover" href="https://space.bilibili.com/148389186" target="_blank">BiliBili<i class="icon-dot bg-color7"></i></a></div><div class="author-info-articles"><a class="author-info-articles-archives article-meta" href="/archives"><span class="pull-top">日志</span><span class="pull-bottom">88</span></a><a class="author-info-articles-tags article-meta" href="/tags"><span class="pull-top">标签</span><span class="pull-bottom">82</span></a><a class="author-info-articles-categories article-meta" href="/categories"><span class="pull-top">分类</span><span class="pull-bottom">16</span></a></div><div class="friend-link"><a class="friend-link-text" target="_blank">欢迎关注本站微信公众号：TeamsSix</a><a class="friend-link-text" href="https://www.loongten.com/" target="_blank">友情链接：loongten</a></div></div></div><div id="main-container"><header><div id="menu-outer"><i class="menu-list-icon fas fa-bars"></i><nav id="menu-inner"><a class="menu-item" href="/">首页</a><a class="menu-item" href="/tags">标签</a><a class="menu-item" href="/categories">分类</a><a class="menu-item" href="/archives">归档</a></nav><div class="right-info"><a class="title-name" href="/">Teams Six</a><span id="now-time"></span></div></div></header><div id="content-outer"><div id="content-inner"><article id="post"><div class="post-header"><div class="title">【CS学习笔记】5、如何建立Payload处理器</div><div class="container"><time class="button-hover post-date"><i class="fas fa-calendar-alt article-icon" aria-hidden="true"></i> 发表于 2020-04-19 | 更新于 2020-04-25</time><!--time.button-hover.post-date #[i.fas.fa-calendar-alt.article-icon(aria-hidden="true")] #[=__('post.modified')] #[=date(page['updated'], config.date_format)]--><div class="button-hover categories"><i class="fa fa-inbox article-icon" aria-hidden="true"></i><a class="link-a" href="/categories/学习笔记/">学习笔记</a></div><div class="button-hover tags"><i class="fa fa-tag article-icon" aria-hidden="true"></i><a class="link-a" href="/tags/Cobalt-Strike/">Cobalt Strike</a><span>&nbsp;|&nbsp;</span><i class="fa fa-tag article-icon" aria-hidden="true"></i><a class="link-a" href="/tags/学习笔记/">学习笔记</a><span>&nbsp;|&nbsp;</span><i class="fa fa-tag article-icon" aria-hidden="true"></i><a class="link-a" href="/tags/红队/">红队</a></div></div></div><div class="main-content"><p>这一小节学起来感觉有些吃力，里面很多概念理解的不是很清楚，如果有大佬看到描述错误的地方欢迎留言指正，避免误导他人。</p>
<p>再次声明，这只是我的个人学习笔记，不要当成教程去看，建议想学习CS的小伙伴可以看看A-TEAM的中文手册或者网上的一些视频教程。</p>
<a id="more"></a>

<h1 id="0x00-监听器管理"><a href="#0x00-监听器管理" class="headerlink" title="0x00 监听器管理"></a>0x00 监听器管理</h1><ul>
<li><p>什么是监听器</p>
<p>顾名思义，监听器就是等待被入侵系统连接自己的一个服务。</p>
</li>
<li><p>监听器的作用</p>
<p>主要是为了接受payload回传的各类数据，类似于MSF中handler的作用。</p>
<p>比如payload在目标机器执行以后，就会回连到监听器然后下载执行真正的shellcode代码。</p>
</li>
</ul>
<p>一旦监听器建立起来，团队成员只需要知道这个监听器的名称即可，不用关心监听器背后的基础环境，接下来将深入了解如何准确配置监听器。</p>
<p>一个监听器由用户定义的名称、payload 类型和几个特定于 payload 的选项组成。</p>
<p>监听器的名字一般由以下结构组成：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Operating System/Payload/Stager</span><br></pre></td></tr></table></figure>

<p>例如：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">windows/beacon_http/reverse_http</span><br></pre></td></tr></table></figure>

<h1 id="0x01-什么是传输器"><a href="#0x01-什么是传输器" class="headerlink" title="0x01 什么是传输器"></a>0x01 什么是传输器</h1><p>攻击载荷<code>payload</code>就是攻击执行的内容。攻击载荷通常被分为两部分：传输器<code>stager</code> 和传输体<code>stage</code>。</p>
<p>传输器<code>stager</code>是一个小程序，用于连接、下载传输体<code>stage</code>，并插入到内存中。</p>
<p>我个人理解为：攻击载荷里真正用于攻击的代码是在传输体里。</p>
<p>所以为什么要有传输体？直接把攻击载荷插入到内存中不更方便快捷、更香么，搞得又是传输器又是传输体的。</p>
<p>需要传输体是因为在很多攻击中对于能加载进内存，并在成功漏洞利用后执行的数据大小存在严格限制。这就导致在攻击成功时，很难嵌入额外的攻击载荷，正是因为这些限制，才使得传输器变得有必要了。</p>
<h1 id="0x02-创建监听器"><a href="#0x02-创建监听器" class="headerlink" title="0x02 创建监听器"></a>0x02 创建监听器</h1><p>在CS客户端中打开 Cobalt Strike —》Listeners，之后点击Add，此时弹出New Listener窗口，在填写监听器的相关信息之前，需要先来了解监听器有哪些类型。</p>
<p>Cobalt Strike有两种类型的监听器：</p>
<ul>
<li><p>Beacon</p>
<p>Beacon直译过来就是灯塔、信标、照亮指引的意思，Beacon是较为隐蔽的后渗透代理，笔者个人理解Beacon类型的监听器应该是平时比较常用的。Beacon监听器的名称例如：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">windows/beacon_http/reverse_http</span><br></pre></td></tr></table></figure>
</li>
<li><p>Foreign</p>
<p>Foreign直译就是外部的，这里可以理解成<code>对外监听器</code>，这种类型的监听器主要作用是给其他的Payload提供别名，比如Metasploit 框架里的Payload，笔者个人理解Foreign监听器在一定程度上提高了CS的兼容性。对外监听器的名称例如：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">windows/foreign/reverse_https</span><br></pre></td></tr></table></figure>

</li>
</ul>
<h1 id="0x03-Beacon是什么"><a href="#0x03-Beacon是什么" class="headerlink" title="0x03 Beacon是什么"></a>0x03 Beacon是什么</h1><ul>
<li>Beacon是CS的Payload</li>
<li>Beacon有两种通信模式。一种是异步通信模式，这种模式通信效率缓慢，Beacon回连团队服务器、下载任务、然后休眠；另一种是交互式通信模式，这种模式的通信是实时发生的。</li>
<li>通过HTTP、HTTPS和DNS出口网络</li>
<li>使用SMB协议的时候是点对点通信</li>
<li>Beacon有很多的后渗透攻击模块和远程管理工具</li>
</ul>
<h1 id="0x04-Beacon的类型"><a href="#0x04-Beacon的类型" class="headerlink" title="0x04 Beacon的类型"></a>0x04 Beacon的类型</h1><ul>
<li><p>HTTP 和 HTTPS Beacon</p>
<p>HTTP和HTTPS Beacon也可以叫做Web Beacon。默认设置情况下，HTTP 和 HTTPS Beacon 通过 HTTP GET 请求来下载任务。这些 Beacon 通过 HTTP POST 请求传回数据。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">windows/beacon_http/reverse_http</span><br><span class="line">windows/beacon_https/reverse_https</span><br></pre></td></tr></table></figure>
</li>
<li><p>DNS Beacon</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">windows/beacon_dns/reverse_dns_txt</span><br><span class="line">windows/beacon_dns/reverse_http</span><br></pre></td></tr></table></figure>
</li>
<li><p>SMB Beacon</p>
<p>SMB Beacon也可以叫做pipe beacon</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">windows/beacon_smb/bind_pipe</span><br></pre></td></tr></table></figure>

</li>
</ul>
<h1 id="0x05-创建一个HTTP-Beacon"><a href="#0x05-创建一个HTTP-Beacon" class="headerlink" title="0x05 创建一个HTTP Beacon"></a>0x05 创建一个HTTP Beacon</h1><p>点击 Cobalt Strike  –&gt; Listeners 打开监听器管理窗口，点击Add，输入监听器的名称、监听主机地址，因为这里是要创建一个HTTP Beacon，所以其他的默认就行，最后点击Save</p>
<p><img src="https://teamssix.oss-cn-hangzhou.aliyuncs.com/cs5-1.png" alt></p>
<p>此时可以测试一下刚才设置的监听器，点击Attack –&gt; Web Drive-by –&gt; Scripted Web Delivery(s) ，在弹出的窗口中选择刚才新添的Listener，因为我的靶机是64位的，所以我把Use x64 payload也给勾选上了，最后点击Launch</p>
<p><img src="https://teamssix.oss-cn-hangzhou.aliyuncs.com/cs5-2.png" alt></p>
<p>复制弹窗的命令，放到靶机中运行</p>
<p><img src="https://teamssix.oss-cn-hangzhou.aliyuncs.com/cs5-3.png" alt></p>
<p><img src="https://teamssix.oss-cn-hangzhou.aliyuncs.com/cs5-4.png" alt></p>
<p>此时，回到CS，就可以看到已经靶机上线了</p>
<p><img src="https://teamssix.oss-cn-hangzhou.aliyuncs.com/cs5-5.png" alt></p>
<h1 id="0x06-重定向器"><a href="#0x06-重定向器" class="headerlink" title="0x06 重定向器"></a>0x06 重定向器</h1><p>刚才创建了一个HTTP Beacon，接下来来看一下重定向器<code>Redirectors</code></p>
<p>重定向器是一个位于CS团队服务器和目标网络之间的服务器，这个重定向器通俗的来说就是一个代理工具，或者说端口转发工具，担任CS服务器与目标服务器之间的跳板机角色，整体流量就像下面这样。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">目标靶机 &lt;--------&gt;多个并列的重定向器&lt;------&gt;CS服务器</span><br></pre></td></tr></table></figure>

<p>重定向器在平时的攻击或者防御的过程中起到很重要的作用，主要有以下两点：</p>
<ul>
<li>保护自己的CS服务器，避免目标发现自己的真实IP</li>
<li>提高整体可靠性，因为可以设置多个重定向器，因此如果有个别重定向器停止工作了，整体上系统依旧是可以正常工作的</li>
</ul>
<h1 id="0x07-创建一个重定向器"><a href="#0x07-创建一个重定向器" class="headerlink" title="0x07 创建一个重定向器"></a>0x07 创建一个重定向器</h1><p>这里就使用自己的内网环境作为测试了，首先理清自己的IP</p>
<p>CS服务器IP：192.168.175.129</p>
<p>目标靶机IP：192.168.175.130</p>
<p>重定向器IP：192.168.175.132、192.168.175.133</p>
<p>首先，需要先配置重定向器的端口转发，比如这里使用HTTP Beacon，就需要将重定向器的80端口流量全部转发到CS服务器上，使用socat的命令如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">socat TCP4-LISTEN:80,fork TCP4:192.168.175.129:80</span><br></pre></td></tr></table></figure>

<p><img src="https://teamssix.oss-cn-hangzhou.aliyuncs.com/cs5-7.png" alt></p>
<p><img src="https://teamssix.oss-cn-hangzhou.aliyuncs.com/cs5-6.png" alt></p>
<p>如果提示没有socat命令，安装一下即可。重定向器设置好之后，就新建一个HTTP Beacon，并把重定向器添加到HTTP Hosts主机列表中</p>
<p><img src="https://teamssix.oss-cn-hangzhou.aliyuncs.com/cs5-8.png" alt></p>
<p>此时可以测试一下重定向器是否正常工作，在CS中打开 View –&gt; Web Log，之后浏览器访问CS服务器地址，也就是这里的192.168.175.129</p>
<p><img src="https://teamssix.oss-cn-hangzhou.aliyuncs.com/cs5-9.png" alt></p>
<p><img src="https://teamssix.oss-cn-hangzhou.aliyuncs.com/cs5-10.png" alt></p>
<p>可以看到CS是能够正常接收到流量的，说明重定向器已经配置OK了，此时按照上面创建一个HTTP Beacon的操作，创建一个HTTP Beacon，并在靶机中运行</p>
<p>当靶机上线的时候，观察靶机中的流量，可以看到与靶机连接的也是重定向器的IP</p>
<p><img src="https://teamssix.oss-cn-hangzhou.aliyuncs.com/cs5-11.png" alt></p>
<p>在CS中也可以看到上线主机的外部IP也是重定向器的IP，此时如果关闭一个重定向器，系统依旧可以正常工作。</p>
<p><img src="https://teamssix.oss-cn-hangzhou.aliyuncs.com/cs5-12.png" alt></p>
<h1 id="0x08-HTTPS-Beacon"><a href="#0x08-HTTPS-Beacon" class="headerlink" title="0x08 HTTPS Beacon"></a>0x08 HTTPS Beacon</h1><p>HTTPS Beaocn和HTTP Beacon一样，使用了相同的Malleable C2配置文件，使用GET和POST的方式传输数据，不同点在于HTTPS使用了SSL，因此HTTPS Beacon就需要使用一个有效的SSL证书，具体如何配置可以参考：<a href="https://www.cobaltstrike.com/help-malleable-c2#validssl" target="_blank" rel="noopener">https://www.cobaltstrike.com/help-malleable-c2#validssl</a></p>
<blockquote>
<p>参考链接：</p>
<p><a href="https://www.bilibili.com/video/BV16b411i7n5" target="_blank" rel="noopener">https://www.bilibili.com/video/BV16b411i7n5</a></p>
<p><a href="https://klionsec.github.io/2017/09/23/cobalt-strike/" target="_blank" rel="noopener">https://klionsec.github.io/2017/09/23/cobalt-strike/</a></p>
<p><a href="https://blog.ateam.qianxin.com/CobaltStrike4.0%E7%94%A8%E6%88%B7%E6%89%8B%E5%86%8C_%E4%B8%AD%E6%96%87%E7%BF%BB%E8%AF%91.pdf" target="_blank" rel="noopener">https://blog.ateam.qianxin.com/CobaltStrike4.0%E7%94%A8%E6%88%B7%E6%89%8B%E5%86%8C_%E4%B8%AD%E6%96%87%E7%BF%BB%E8%AF%91.pdf</a></p>
<p>更多信息欢迎关注我的微信公众号：TeamsSix</p>
</blockquote>
<p><img src="https://teamssix.oss-cn-hangzhou.aliyuncs.com/TeamsSix_Subscription_Logo2.png" alt></p>
</div><div class="post-copyright"><div class="post-copyright-author"><span class="post-copyright-meta">本文作者: </span><span class="post-copyright-info"><a href="mailto:undefined">Teams Six</a></span></div><div class="post-copyright-type"><span class="post-copyright-meta">本文链接: </span><span class="post-copyright-info"><a href="https://www.teamssix.com/year/200419-150454.html">https://www.teamssix.com/year/200419-150454.html</a></span></div><div class="post-copyright-notice"><span class="post-copyright-meta">版权声明: </span><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来自 <a href="https://www.teamssix.com">Teams Six</a>！</span></div></div></article><div id="pagination"><div class="prev-post pull-left"><span class="line line-top"></span><span class="line line-right"></span><span class="line line-bottom"></span><span class="line line-left"></span><a href="/year/200419-150502.html"><i class="fas fa-angle-left">&nbsp;</i><span>【CS学习笔记】6、DNS_beacon的作用</span></a></div><div class="next-post pull-right"><span class="line line-top"></span><span class="line line-right"></span><span class="line line-bottom"></span><span class="line line-left"></span><a href="/year/200419-150447.html"><span>【CS学习笔记】4、快速登陆和生成会话报告</span><span>&nbsp;</span><i class="fas fa-angle-right"></i></a></div></div><!--div!= paginator()--></div></div><div class="button-hover" id="return-top"><i class="fas fa-arrow-up" aria-hidden="true"></i></div><footer><div id="footer"><div class="button-hover" id="side-button"><i class="fas fa-arrow-right"></i></div><div class="right-content"><div class="busuanzi"><script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><span id="busuanzi_container_page_pv"><i class="fas fa-file-o"></i></span><span id="busuanzi_value_page_pv"></span><span></span></div><div class="copyright">&copy;2017 ～ 2020 By Teams Six</div></div></div></footer></div><!--js(src=url_for(url) + '?version=' + version())--><script src="/js/thirdparty/jquery-3.3.1.min.js"></script><!--script(src=url)--><!--js(src=url_for(url) + '?version=' + version())--><script src="/js/thirdparty/velocity.min.js"></script><!--script(src=url)--><!--js(src=url_for(url) + '?version=' + version())--><script src="/js/thirdparty/jquery.mCustomScrollbar.concat.min.js"></script><!--script(src=url)--><!--js(src=url_for(url) + '?version=' + version())--><script src="/js/fan.js"></script><!--script(src=url)--><!--js(src=url_for(url) + '?version=' + version())--><script src="/js/canvas_bg.js"></script><!--script(src=url)--><!--js(src=url_for(url) + '?version=' + version())--><script src="/js/utils.js"></script><!--script(src=url)--><!--js(src=url_for(url) + '?version=' + version())--><script src="/js/scroll.js"></script><!--script(src=url)--><!--js(src=url_for(url) + '?version=' + version())--><script src="/js/sidebar.js"></script><!--script(src=url)--><!--js(src=url_for(url) + '?version=' + version())--><script src="/js/copy.js"></script><!--script(src=url)--></body></html>